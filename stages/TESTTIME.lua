-- Generated by ProvEdit version 0.1 --
local STAGE_INFO = {
    name = "teststage",
    subname = "",
    width = 1920,
    height = 1056,
    music = ":nothing:"
}

local STAGE_LAYERS = {
    {
        depth = 12,
        sprite = "Tile16Snow",
        origin = "Vanilla",
        tiles = {
            [49] = {
                [22] = {0,1}, [24] = {0,2}, [35] = {3,3}, [18] = {2,1}, [20] = {1,1}, [10] = {3,1}, [14] = {0,1}, [34] = {3,2}, [31] = {0,1}, [32] = {2,1}, [11] = {2,1}, [15] = {0,1}, [23] = {0,1}, [25] = {0,3}, [19] = {2,1}, [21] = {1,1}, [12] = {1,1}, [16] = {0,2}, [33] = {3,1}, [13] = {1,1}, 
                [17] = {3,1}, 
            },
            [51] = {
                [22] = {2,1}, [24] = {1,1}, [18] = {1,1}, [20] = {3,1}, [14] = {2,1}, [34] = {3,3}, [31] = {2,1}, [30] = {1,1}, [32] = {3,1}, [15] = {2,1}, [28] = {0,1}, [29] = {0,1}, [26] = {0,1}, [27] = {0,1}, [23] = {2,1}, [25] = {0,1}, [19] = {1,1}, [21] = {3,1}, [12] = {3,1}, [16] = {1,1}, 
                [33] = {3,2}, [13] = {3,1}, [17] = {1,1}, 
            },
            [45] = {
                [22] = {3,2}, [24] = {1,3}, [35] = {1,1}, [18] = {0,2}, [36] = {3,1}, [10] = {0,1}, [34] = {0,1}, [11] = {0,2}, [38] = {3,2}, [37] = {3,1}, [39] = {3,3}, [28] = {7,1}, [26] = {6,0}, [27] = {7,0}, [23] = {3,3}, [25] = {6,0}, [19] = {0,3}, [21] = {3,1}, [12] = {0,3}, [33] = {1,1}, 
                [17] = {0,1}, [9] = {0,1}, 
            },
            [47] = {
                [22] = {3,1}, [24] = {3,3}, [35] = {3,1}, [18] = {0,1}, [20] = {0,2}, [36] = {3,2}, [10] = {1,1}, [14] = {0,3}, [34] = {2,1}, [32] = {0,1}, [11] = {0,1}, [37] = {3,3}, [23] = {3,2}, [19] = {0,1}, [21] = {0,3}, [12] = {0,2}, [33] = {3,1}, [13] = {0,3}, [17] = {1,1}, [9] = {2,1}, 
            },
            [37] = {
                [22] = {2,3}, [24] = {3,1}, [35] = {2,3}, [18] = {0,1}, [20] = {0,3}, [36] = {0,1}, [34] = {1,3}, [44] = {3,3}, [31] = {0,2}, [42] = {3,1}, [30] = {0,3}, [32] = {0,3}, [38] = {0,3}, [37] = {0,2}, [40] = {3,3}, [39] = {3,3}, [28] = {0,1}, [29] = {0,2}, [26] = {2,1}, [27] = {1,1}, 
                [23] = {3,3}, [25] = {3,2}, [19] = {0,2}, [21] = {0,3}, [33] = {1,3}, [43] = {3,2}, [41] = {0,1}, [17] = {7,0}, 
            },
            [41] = {
                [22] = {3,1}, [24] = {3,3}, [18] = {0,2}, [20] = {1,3}, [36] = {3,1}, [42] = {3,2}, [31] = {1,3}, [30] = {2,3}, [32] = {1,3}, [38] = {2,1}, [37] = {3,1}, [40] = {3,1}, [39] = {2,1}, [28] = {2,3}, [29] = {2,3}, [26] = {3,3}, [27] = {2,3}, [23] = {3,2}, [25] = {3,3}, [19] = {0,3}, 
                [21] = {2,3}, [33] = {1,3}, [43] = {3,3}, [41] = {3,1}, [17] = {0,1}, 
            },
            [29] = {
                [22] = {0,1}, [35] = {0,3}, [24] = {0,3}, [18] = {3,1}, [20] = {3,3}, [34] = {0,2}, [14] = {2,1}, [44] = {0,3}, [42] = {3,3}, [31] = {3,1}, [30] = {3,3}, [32] = {3,2}, [15] = {0,1}, [40] = {3,1}, [28] = {3,1}, [29] = {3,2}, [26] = {3,3}, [27] = {2,1}, [23] = {0,2}, [25] = {3,3}, 
                [19] = {3,2}, [21] = {0,2}, [16] = {0,2}, [33] = {3,3}, [43] = {3,3}, [41] = {3,2}, [17] = {1,1}, 
            },
            [33] = {
                [22] = {0,3}, [24] = {3,1}, [35] = {0,3}, [18] = {3,2}, [20] = {0,1}, [34] = {0,2}, [44] = {3,3}, [31] = {6,0}, [42] = {3,1}, [30] = {3,3}, [32] = {6,0}, [15] = {3,1}, [28] = {3,1}, [29] = {3,2}, [26] = {3,3}, [27] = {0,3}, [23] = {1,3}, [25] = {3,2}, [19] = {3,3}, [21] = {0,2}, 
                [16] = {3,1}, [33] = {0,1}, [43] = {3,2}, [17] = {3,1}, 
            },
            [23] = {
                [22] = {3,1}, [24] = {0,2}, [18] = {3,1}, [20] = {3,1}, [34] = {0,3}, [14] = {0,2}, [31] = {1,3}, [30] = {2,3}, [32] = {0,1}, [38] = {3,2}, [15] = {0,3}, [37] = {3,1}, [40] = {2,3}, [39] = {3,3}, [28] = {3,3}, [29] = {3,3}, [26] = {1,3}, [27] = {3,2}, [23] = {0,1}, [25] = {0,3}, 
                [19] = {3,1}, [21] = {3,1}, [16] = {3,1}, [33] = {0,2}, [41] = {0,3}, [13] = {0,1}, [17] = {3,1}, 
            },
            [28] = {
                [22] = {0,1}, [35] = {0,3}, [24] = {0,3}, [18] = {3,1}, [20] = {3,3}, [34] = {0,2}, [14] = {1,1}, [42] = {3,3}, [31] = {3,3}, [30] = {3,2}, [32] = {3,3}, [15] = {0,1}, [40] = {3,2}, [39] = {3,1}, [28] = {2,1}, [29] = {3,1}, [26] = {3,3}, [27] = {1,1}, [23] = {0,2}, [25] = {2,3}, 
                [19] = {3,2}, [21] = {0,2}, [16] = {0,2}, [33] = {2,3}, [43] = {2,3}, [41] = {3,3}, [17] = {0,1}, 
            },
            [15] = {
                [22] = {5,1}, [24] = {5,0}, [28] = {5,1}, [29] = {5,1}, [26] = {5,1}, [27] = {5,1}, [23] = {6,1}, [25] = {5,1}, [21] = {5,0}, 
            },
            [20] = {
                [22] = {0,1}, [35] = {3,3}, [24] = {0,1}, [18] = {0,1}, [20] = {0,1}, [36] = {3,3}, [14] = {0,1}, [34] = {3,3}, [31] = {0,1}, [30] = {3,3}, [32] = {0,2}, [38] = {2,3}, [15] = {0,2}, [37] = {3,3}, [39] = {1,3}, [28] = {3,3}, [29] = {3,3}, [26] = {0,3}, [27] = {3,3}, [23] = {0,1}, 
                [25] = {0,2}, [19] = {0,1}, [21] = {0,1}, [16] = {0,1}, [33] = {0,3}, [17] = {0,1}, 
            },
            [12] = {
                [22] = {5,0}, [23] = {5,1}, 
            },
            [38] = {
                [22] = {3,3}, [24] = {0,3}, [35] = {3,3}, [18] = {1,1}, [20] = {1,3}, [36] = {0,1}, [34] = {2,3}, [44] = {3,3}, [31] = {0,2}, [42] = {3,1}, [30] = {0,3}, [32] = {0,3}, [38] = {0,2}, [37] = {0,1}, [40] = {0,1}, [39] = {0,3}, [28] = {0,1}, [29] = {0,2}, [26] = {0,3}, [27] = {2,1}, 
                [23] = {1,3}, [25] = {0,3}, [19] = {1,2}, [21] = {1,3}, [33] = {2,3}, [43] = {3,2}, [41] = {1,1}, 
            },
            [42] = {
                [22] = {2,3}, [24] = {3,2}, [18] = {0,2}, [20] = {2,3}, [36] = {0,1}, [42] = {3,3}, [31] = {2,3}, [30] = {3,3}, [32] = {2,3}, [38] = {3,1}, [37] = {2,1}, [40] = {3,1}, [39] = {3,1}, [28] = {3,3}, [29] = {3,3}, [26] = {3,2}, [27] = {3,3}, [23] = {3,1}, [25] = {3,1}, [19] = {0,3}, 
                [21] = {3,3}, [33] = {2,3}, [41] = {3,2}, [17] = {0,1}, 
            },
            [30] = {
                [22] = {0,2}, [35] = {0,3}, [24] = {1,3}, [18] = {3,1}, [20] = {3,3}, [34] = {0,2}, [14] = {3,1}, [44] = {1,3}, [42] = {3,2}, [31] = {3,2}, [30] = {3,1}, [32] = {3,3}, [15] = {0,1}, [28] = {3,2}, [29] = {3,3}, [26] = {3,3}, [27] = {3,1}, [23] = {0,3}, [25] = {3,2}, [19] = {3,2}, 
                [21] = {0,1}, [16] = {0,1}, [33] = {0,1}, [43] = {3,3}, [41] = {3,1}, [17] = {2,1}, 
            },
            [34] = {
                [22] = {0,3}, [24] = {3,2}, [35] = {0,3}, [18] = {3,2}, [20] = {0,1}, [36] = {0,1}, [34] = {0,2}, [44] = {3,3}, [31] = {0,3}, [42] = {3,1}, [30] = {3,3}, [32] = {7,0}, [38] = {0,3}, [15] = {7,0}, [37] = {0,2}, [40] = {0,3}, [39] = {0,3}, [28] = {0,3}, [29] = {0,3}, [26] = {0,1}, 
                [27] = {0,2}, [23] = {2,3}, [25] = {3,3}, [19] = {3,3}, [21] = {0,2}, [16] = {6,0}, [33] = {0,1}, [43] = {3,2}, [17] = {3,1}, 
            },
            [21] = {
                [22] = {1,1}, [35] = {3,1}, [24] = {0,1}, [18] = {1,1}, [20] = {1,1}, [36] = {3,2}, [14] = {0,1}, [31] = {0,1}, [30] = {3,3}, [32] = {0,2}, [38] = {3,3}, [15] = {0,2}, [37] = {3,3}, [40] = {0,3}, [39] = {2,3}, [28] = {3,1}, [29] = {3,2}, [26] = {0,3}, [27] = {2,1}, [23] = {1,1}, 
                [25] = {0,2}, [19] = {1,1}, [21] = {1,1}, [16] = {1,1}, [33] = {0,3}, [17] = {1,1}, 
            },
            [26] = {
                [22] = {0,2}, [35] = {5,1}, [24] = {0,2}, [18] = {3,2}, [20] = {2,3}, [34] = {0,3}, [14] = {0,1}, [31] = {3,3}, [42] = {1,3}, [30] = {3,2}, [32] = {2,3}, [15] = {0,2}, [40] = {3,2}, [39] = {3,1}, [28] = {0,1}, [29] = {3,1}, [26] = {3,3}, [23] = {0,1}, [25] = {0,3}, [19] = {3,3}, 
                [21] = {3,3}, [16] = {0,3}, [33] = {0,3}, [43] = {0,3}, [41] = {3,3}, [13] = {2,1}, [17] = {3,1}, 
            },
            [13] = {
                [22] = {5,0}, [23] = {5,1}, 
            },
            [18] = {
                [22] = {1,3}, [24] = {0,2}, [35] = {1,3}, [18] = {1,3}, [20] = {1,3}, [36] = {1,3}, [34] = {1,3}, [31] = {0,1}, [30] = {1,3}, [32] = {0,2}, [38] = {0,3}, [15] = {0,1}, [37] = {1,3}, [28] = {1,3}, [29] = {1,3}, [26] = {1,3}, [27] = {1,3}, [23] = {0,3}, [25] = {0,3}, [19] = {1,3}, 
                [21] = {1,3}, [16] = {0,2}, [33] = {0,3}, [17] = {0,3}, 
            },
            [53] = {
                [22] = {3,2}, [24] = {3,1}, [18] = {3,1}, [20] = {3,1}, [31] = {3,1}, [30] = {3,1}, [32] = {3,2}, [28] = {2,1}, [29] = {2,1}, [26] = {2,1}, [27] = {2,1}, [23] = {3,3}, [25] = {2,1}, [19] = {3,1}, [21] = {3,1}, [16] = {3,1}, [33] = {3,3}, [17] = {3,1}, 
            },
            [54] = {
                [31] = {3,3}, [30] = {3,2}, [28] = {3,1}, [29] = {3,1}, [26] = {3,1}, [27] = {3,1}, [25] = {3,1}, 
            },
            [50] = {
                [22] = {1,1}, [24] = {0,1}, [35] = {3,3}, [18] = {3,1}, [20] = {2,1}, [14] = {1,1}, [34] = {3,2}, [31] = {1,1}, [30] = {0,1}, [32] = {3,1}, [11] = {3,1}, [15] = {1,1}, [26] = {0,3}, [23] = {1,1}, [25] = {0,2}, [19] = {3,1}, [21] = {2,1}, [12] = {2,1}, [16] = {0,1}, [33] = {3,1}, 
                [13] = {2,1}, [17] = {0,1}, 
            },
            [52] = {
                [22] = {3,1}, [24] = {2,1}, [18] = {2,1}, [20] = {2,1}, [14] = {3,1}, [34] = {3,3}, [31] = {3,1}, [30] = {2,1}, [32] = {3,1}, [15] = {3,1}, [28] = {1,1}, [29] = {1,1}, [26] = {1,1}, [27] = {1,1}, [23] = {3,1}, [25] = {1,1}, [19] = {2,1}, [21] = {2,1}, [12] = {3,1}, [16] = {2,1}, 
                [33] = {3,2}, [13] = {3,2}, [17] = {2,1}, 
            },
            [46] = {
                [22] = {3,2}, [24] = {2,3}, [35] = {2,1}, [18] = {0,2}, [36] = {3,1}, [10] = {0,1}, [34] = {1,1}, [11] = {0,2}, [38] = {3,3}, [37] = {3,2}, [28] = {7,1}, [26] = {7,0}, [27] = {7,0}, [23] = {3,3}, [25] = {7,0}, [19] = {0,3}, [21] = {3,1}, [12] = {0,3}, [33] = {2,1}, [13] = {0,3}, 
                [17] = {0,1}, [9] = {1,1}, 
            },
            [48] = {
                [22] = {0,2}, [24] = {3,3}, [35] = {3,2}, [18] = {1,1}, [20] = {0,1}, [36] = {3,3}, [10] = {2,1}, [14] = {0,2}, [34] = {3,1}, [32] = {1,1}, [11] = {1,1}, [15] = {0,3}, [23] = {0,3}, [19] = {1,1}, [21] = {0,1}, [12] = {0,1}, [33] = {3,1}, [13] = {0,1}, [17] = {2,1}, [9] = {3,1}, 
            },
            [39] = {
                [22] = {3,3}, [24] = {1,3}, [18] = {2,1}, [20] = {2,3}, [36] = {1,1}, [34] = {3,3}, [44] = {3,3}, [42] = {3,1}, [31] = {0,1}, [30] = {0,3}, [32] = {0,2}, [38] = {0,1}, [37] = {1,1}, [40] = {1,1}, [39] = {0,1}, [28] = {0,3}, [29] = {0,3}, [26] = {1,3}, [27] = {0,3}, [23] = {2,3}, 
                [25] = {1,3}, [19] = {2,2}, [21] = {2,3}, [33] = {0,3}, [43] = {3,2}, [41] = {2,1}, 
            },
            [43] = {
                [22] = {3,3}, [24] = {5,1}, [18] = {0,2}, [20] = {3,3}, [36] = {1,1}, [31] = {3,3}, [30] = {3,3}, [32] = {3,3}, [38] = {3,2}, [37] = {3,1}, [39] = {3,3}, [28] = {3,3}, [29] = {3,3}, [26] = {3,2}, [27] = {3,3}, [23] = {1,3}, [25] = {3,1}, [19] = {0,3}, [21] = {3,3}, [33] = {3,3}, 
                [17] = {0,1}, 
            },
            [31] = {
                [22] = {0,2}, [24] = {2,3}, [35] = {0,3}, [18] = {3,2}, [20] = {0,2}, [34] = {0,2}, [14] = {6,0}, [44] = {2,3}, [42] = {3,2}, [31] = {3,2}, [30] = {3,1}, [32] = {3,3}, [15] = {1,1}, [28] = {3,2}, [29] = {3,3}, [26] = {3,3}, [27] = {0,3}, [23] = {0,3}, [25] = {3,2}, [19] = {3,3}, 
                [21] = {0,1}, [16] = {1,1}, [33] = {0,1}, [43] = {3,3}, [41] = {3,1}, [17] = {3,1}, 
            },
            [35] = {
                [22] = {0,3}, [24] = {3,2}, [35] = {0,3}, [18] = {3,2}, [20] = {0,2}, [36] = {0,1}, [34] = {0,2}, [44] = {3,3}, [31] = {1,3}, [42] = {3,1}, [30] = {0,3}, [32] = {0,3}, [38] = {0,3}, [37] = {0,2}, [40] = {1,3}, [39] = {1,3}, [28] = {0,3}, [29] = {0,2}, [26] = {0,1}, [27] = {0,2}, 
                [23] = {3,3}, [25] = {3,3}, [19] = {0,1}, [21] = {0,3}, [16] = {7,0}, [33] = {0,1}, [43] = {3,2}, [17] = {3,1}, 
            },
            [24] = {
                [22] = {3,3}, [24] = {0,2}, [18] = {3,3}, [20] = {0,3}, [34] = {0,3}, [14] = {0,2}, [31] = {2,3}, [30] = {3,3}, [32] = {0,3}, [38] = {3,1}, [15] = {0,3}, [40] = {3,3}, [39] = {3,2}, [28] = {3,1}, [29] = {3,2}, [26] = {2,3}, [27] = {3,3}, [23] = {0,1}, [25] = {0,3}, [19] = {2,3}, 
                [21] = {3,2}, [16] = {3,1}, [33] = {0,2}, [41] = {1,3}, [13] = {0,1}, [17] = {3,2}, 
            },
            [27] = {
                [22] = {0,1}, [35] = {0,3}, [24] = {0,3}, [18] = {3,1}, [20] = {3,3}, [34] = {0,2}, [14] = {0,1}, [42] = {2,3}, [31] = {3,3}, [30] = {3,2}, [32] = {3,3}, [15] = {0,2}, [40] = {3,2}, [39] = {3,1}, [28] = {1,1}, [29] = {3,1}, [26] = {3,3}, [27] = {0,1}, [23] = {0,2}, [25] = {1,3}, 
                [19] = {3,2}, [21] = {0,1}, [16] = {0,3}, [33] = {1,3}, [43] = {1,3}, [41] = {3,3}, [13] = {3,1}, [17] = {1,1}, 
            },
            [16] = {
                [22] = {5,1}, [24] = {5,1}, [18] = {5,0}, [20] = {5,1}, [30] = {5,1}, [28] = {6,1}, [29] = {6,1}, [26] = {6,1}, [27] = {6,1}, [23] = {5,1}, [25] = {5,1}, [19] = {5,1}, [21] = {5,1}, 
            },
            [19] = {
                [22] = {2,3}, [24] = {0,3}, [35] = {2,3}, [18] = {2,3}, [20] = {2,3}, [36] = {2,3}, [14] = {5,0}, [34] = {2,3}, [31] = {0,1}, [30] = {2,3}, [32] = {0,2}, [38] = {1,3}, [15] = {0,1}, [37] = {2,3}, [39] = {0,3}, [28] = {2,3}, [29] = {2,3}, [26] = {2,3}, [27] = {2,3}, [23] = {1,3}, 
                [25] = {1,3}, [19] = {2,3}, [21] = {2,3}, [16] = {0,2}, [33] = {0,3}, [17] = {0,3}, 
            },
            [40] = {
                [22] = {3,3}, [24] = {2,3}, [18] = {3,1}, [20] = {3,3}, [36] = {2,1}, [44] = {3,3}, [42] = {3,1}, [31] = {0,3}, [30] = {1,3}, [32] = {0,3}, [38] = {1,1}, [37] = {2,1}, [40] = {2,1}, [39] = {1,1}, [28] = {1,3}, [29] = {1,3}, [26] = {2,3}, [27] = {1,3}, [23] = {3,3}, [25] = {2,3}, 
                [19] = {3,2}, [21] = {3,3}, [33] = {0,3}, [43] = {3,2}, [41] = {3,1}, 
            },
            [44] = {
                [22] = {3,3}, [24] = {0,3}, [35] = {0,1}, [18] = {0,2}, [20] = {3,1}, [36] = {2,1}, [34] = {0,1}, [38] = {3,2}, [37] = {3,1}, [39] = {3,3}, [28] = {7,1}, [26] = {5,0}, [27] = {7,0}, [23] = {2,3}, [25] = {5,0}, [19] = {0,3}, [21] = {3,2}, [33] = {0,1}, [17] = {0,1}, 
            },
            [32] = {
                [22] = {0,3}, [24] = {3,3}, [35] = {0,3}, [18] = {3,2}, [20] = {0,1}, [34] = {0,2}, [14] = {7,0}, [44] = {3,3}, [31] = {3,3}, [42] = {3,1}, [30] = {3,2}, [32] = {5,0}, [15] = {2,1}, [28] = {3,3}, [29] = {3,1}, [26] = {3,3}, [27] = {0,3}, [23] = {0,3}, [25] = {3,2}, [19] = {3,3}, 
                [21] = {0,2}, [16] = {2,1}, [33] = {0,1}, [43] = {3,2}, [17] = {3,1}, 
            },
            [36] = {
                [22] = {1,3}, [24] = {3,3}, [35] = {1,3}, [18] = {3,1}, [20] = {0,2}, [36] = {0,1}, [34] = {0,3}, [44] = {3,3}, [31] = {0,3}, [42] = {3,1}, [30] = {0,2}, [32] = {1,3}, [38] = {0,3}, [37] = {0,2}, [40] = {2,3}, [39] = {2,3}, [28] = {0,2}, [29] = {0,3}, [26] = {1,1}, [27] = {0,1}, 
                [23] = {3,2}, [25] = {3,1}, [19] = {0,1}, [21] = {0,3}, [33] = {0,3}, [43] = {3,2}, [17] = {6,0}, 
            },
            [22] = {
                [22] = {2,1}, [24] = {0,1}, [18] = {2,1}, [20] = {2,1}, [14] = {0,1}, [34] = {0,3}, [31] = {0,3}, [30] = {1,3}, [32] = {0,1}, [38] = {3,2}, [15] = {0,2}, [37] = {3,1}, [40] = {1,3}, [39] = {3,3}, [28] = {3,2}, [29] = {3,3}, [26] = {0,3}, [27] = {3,1}, [23] = {2,1}, [25] = {0,2}, 
                [19] = {2,1}, [21] = {2,1}, [16] = {2,1}, [33] = {0,2}, [17] = {2,1}, 
            },
            [25] = {
                [22] = {0,2}, [24] = {0,2}, [18] = {3,3}, [20] = {1,3}, [34] = {0,3}, [14] = {0,1}, [31] = {3,3}, [42] = {0,3}, [30] = {3,2}, [32] = {1,3}, [38] = {3,1}, [15] = {0,2}, [40] = {3,3}, [39] = {3,2}, [28] = {3,2}, [29] = {3,1}, [26] = {3,3}, [27] = {3,1}, [23] = {0,1}, [25] = {0,3}, 
                [19] = {3,3}, [21] = {3,3}, [16] = {3,1}, [33] = {0,2}, [41] = {2,3}, [13] = {1,1}, [17] = {3,2}, 
            },
            [14] = {
                [22] = {5,0}, [23] = {5,1}, 
            },
            [17] = {
                [22] = {0,3}, [24] = {0,1}, [35] = {0,3}, [18] = {0,3}, [20] = {0,3}, [36] = {0,3}, [34] = {0,3}, [31] = {0,1}, [30] = {0,3}, [32] = {0,2}, [37] = {0,3}, [15] = {0,1}, [28] = {0,3}, [29] = {0,3}, [26] = {0,3}, [27] = {0,3}, [23] = {5,1}, [25] = {0,2}, [19] = {0,3}, [21] = {0,3}, 
                [16] = {0,2}, [33] = {0,3}, [17] = {0,3}, 
            },
        }
    },
}

local STAGE_COLLISION = {
    ["BNoSpawn"] = {
        {46,64}, {44,64}, {42,64}, {40,64}, {38,64}, {36,64}, {46,72}, {72,80}, {70,80}, {74,82}, {74,80}, {74,84}, {72,84}, {70,84}, {68,84}, {66,84}, {64,84}, {62,84}, {62,82}, {60,82}, 
        {58,82}, {58,80}, {56,80}, {56,78}, {54,78}, {52,78}, {50,78}, {50,76}, {48,78}, {48,76}, {46,78}, {46,76}, {46,74}, {44,74}, {42,74}, {42,72}, {42,70}, {40,70}, {40,68}, {44,66}, 
        {42,66}, {40,66}, {52,68}, {50,68}, {48,68}, {46,68}, {44,68}, {66,70}, {64,70}, {62,70}, {60,70}, {58,70}, {56,70}, {54,70}, {52,70}, {68,80}, {68,78}, {68,76}, {68,74}, {68,72}, 
        {68,70}, {94,40}, {88,40}, {94,42}, {94,38}, {92,42}, {92,38}, {90,42}, {90,38}, {88,42}, {88,38}, {52,58}, {52,56}, {54,58}, {54,56}, {54,54}, {54,52}, {52,52}, {50,56}, {50,54}, 
        {50,52}, {86,64}, {86,62}, {86,60}, {86,58}, {86,56}, {90,56}, {88,56}, {92,56}, {92,54}, {92,52}, {92,50}, {98,48}, {96,48}, {94,48}, {92,48}, {90,48}, {88,48}, {86,48}, {98,50}, 
        {100,50}, {100,52}, {102,58}, {102,56}, {102,54}, {102,52}, {102,60}, {100,60}, {100,62}, {98,62}, {98,64}, {96,64}, {94,64}, {94,66}, {92,66}, {90,66}, {76,72}, {76,70}, {76,68}, {78,68}, 
        {86,66}, {84,66}, {82,66}, {80,66}, {78,66}, {88,70}, {88,68}, {88,66}, {88,72}, {86,72}, {84,72}, {82,72}, {80,72}, {78,72}, {32,50}, {32,48}, {32,46}, {30,58}, {30,56}, {30,54}, 
        {30,52}, {30,50}, {32,60}, {32,58}, {34,72}, {34,70}, {34,68}, {34,66}, {34,64}, {34,62}, {34,60}, {36,74}, {34,74}, {36,76}, {38,76}, {38,74}, {42,78}, {40,78}, {38,78}, {46,80}, 
        {44,80}, {42,80}, {48,82}, {46,82}, {50,82}, {52,86}, {52,84}, {50,84}, {58,86}, {56,86}, {54,86}, {76,88}, {74,88}, {72,88}, {70,88}, {68,88}, {66,88}, {64,88}, {62,88}, {60,88}, 
        {58,88}, {80,86}, {80,88}, {78,88}, {82,84}, {82,86}, {84,84}, {84,82}, {84,80}, {90,78}, {88,78}, {86,78}, {84,78}, {90,76}, {92,76}, {92,74}, {94,74}, {94,72}, {96,72}, {96,70}, 
        {98,70}, {100,70}, {100,68}, {102,68}, {104,68}, {104,66}, {106,66}, {106,64}, {106,62}, {108,62}, {108,60}, {108,58}, {108,56}, {108,54}, {108,52}, {108,50}, {106,50}, {106,48}, {106,46}, {106,44}, 
        {106,42}, {106,40}, {106,38}, {106,36}, {106,34}, {106,32}, {104,32}, {104,30}, {104,28}, {104,26}, {100,24}, {104,24}, {102,24}, {100,22}, {98,22}, {98,20}, {96,20}, {96,18}, {94,18}, {92,18}, 
        {90,24}, {90,22}, {90,20}, {90,18}, {92,26}, {92,24}, {94,28}, {94,26}, {96,30}, {96,28}, {96,26}, {98,34}, {98,32}, {98,30}, {82,36}, {70,36}, {66,34}, {66,32}, {60,30}, {54,28}, 
        {46,28}, {40,30}, {34,38}, {34,36}, {34,34}, {34,32}, {32,42}, {32,40}, {32,38}, {32,44}, {30,44}, {30,46}, {28,46}, {26,46}, {24,46}, 
    },
    ["B"] = {
        {74,78}, {72,78}, {70,78}, {54,66}, {52,66}, {50,66}, {48,66}, {46,66}, {46,62}, {44,62}, {42,62}, {40,62}, {38,62}, {36,62}, {70,64}, {68,64}, {66,64}, {64,64}, {62,64}, {60,64}, 
        {58,64}, {56,64}, {54,64}, {82,58}, {80,58}, {78,58}, {76,58}, {74,58}, {72,58}, {70,58}, {68,58}, {84,42}, {82,42}, {80,42}, {78,42}, {76,42}, {74,42}, {72,42}, {70,42}, {70,48}, 
        {68,48}, {66,48}, {64,48}, {62,48}, {60,48}, {58,48}, {56,48}, {54,48}, {52,48}, {50,48}, {48,48}, {46,48}, {44,48}, {60,40}, {58,40}, {56,40}, {54,40}, {52,40}, {50,40}, {48,40}, 
        {46,40}, {44,40}, {42,40}, {40,40}, {96,34}, {94,34}, {92,34}, {90,34}, {88,34}, {86,34}, {84,34}, {82,34}, {80,36}, {78,36}, {76,36}, {74,36}, {72,36}, {70,34}, {68,34}, {66,30}, 
        {64,30}, {62,30}, {60,28}, {58,28}, {56,28}, {54,26}, {52,26}, {50,26}, {48,26}, {46,26}, {44,28}, {42,28}, {40,28}, {38,30}, {36,30}, {34,30}, 
    },
    ["Rope"] = {
        {70,76}, {70,74}, {70,72}, {70,70}, {70,68}, {70,66}, {70,64}, {68,62}, {68,60}, {68,58}, {68,56}, {68,54}, {68,52}, {68,50}, {68,48}, {60,46}, {60,44}, {60,42}, {60,40}, {68,46}, 
        {68,44}, {68,42}, {68,40}, {68,38}, {68,36}, {68,34}, 
    },
    ["BossSpawn"] = {
        {92,34}, {90,34}, {88,34}, {86,34}, {84,34}, {82,34}, {54,26}, {52,26}, {50,26}, {48,26}, {46,26}, 
    },
}

local STAGE_OBJECTS = {
}

local STAGE_BACKGROUNDS = {
}

local STAGE_INTERACTABLES = {
}

local STAGE_ENEMIES = {
}

-- LEVEL DATA END --
local function r(t,n,o)local q=_G[t].find(n,o)return q or error("Failed to resolve "..n..":"..o.. " ("..t.."), make sure all resources are loaded before loading the stage.") end

local function mkObjs()
    local bg = Object("PELDR_BG")
    local ts = Object("PELDR_TS")
	local c = camera
	local x,y,w,h=0,0,0,0
    callback("onCameraUpdate", function() if bg:find(1) or ts:find(1) then x,y,w,h=camera.x,camera.y,camera.width,camera.height end end, -100)
    local z = {}
    callback("globalRoomEnd", function(r)
        for k, _ in pairs(z) do
            if Surface.isValid(k) then
                k:free()
            end
        end
    end, -100)
    
    local di,st,rst = graphics.drawImage,graphics.setTarget,graphics.resetTarget
    local function chnk(s, ts, x, y, o)
        local r = {0, 0, 16, 16}
        local d = {image = s, x = 0, y = 0, region = r}
        local sf = Surface(512, 512)
        st(sf)
        local w
        for _x = x / 16, (x + 512) / 16 do
            local q = ts[_x]
            if q ~= nil then
                for _y = y / 16, (y + 512) / 16 do
                    local t = q[_y]
                    if t ~= nil then
                        r[1] = t[1] * 16 + (o or (t[1] + 1))
                        r[2] = t[2] * 16 + (o or (t[2] + 1))
                        d.x = _x * 16 - x
                        d.y = _y * 16 - y
                        w = 1
                        di(d)
                    end
                end
            end
        end
        rst()
        if not w then
            sf:free()
            return 0
        else
            z[sf] = 1
            return sf
        end
    end
    local mf,mc = math.floor, math.ceil
    local vld = Surface.isValid
	ts:addCallback("draw", function(i)
		local d=i:getModData("PELDR")
        local c = d.c
        for X = mf(x / 512), mc((x + w) / 512) do
            local q = c[X]
            if q == nil then
                q = {}
                c[X] = {}
            end
            for Y = mf(y / 512), mc((y + h) / 512) do
                local cc = q[Y]
                if cc ~= 0 and not vld(cc) then
                    if cc ~= nil then
                        z[cc] = nil
                    end
                    cc = chnk(d.s, d.t, X * 512, Y * 512,d.g or 0)
                    q[Y] = cc
                end
                if cc ~= 0 then
                    cc:draw(X * 512, Y * 512)
                end
            end
        end
	end)
    
	bg:addCallback("draw", function(i)
		local d=i:getModData("PELDR")
		local s=d.s
		
		local fx,fy=d.x+x*d.px+w*d.xo,d.y+y*d.py+h*d.yo

		local sw,x1,x2=1,fx,fx
		if d.hr then
			sw = s.width
			x1 = x1 % sw + x - x % sw - sw
			x2 = x + w
		end

		local sh,y1,y2=1,fy,fy
		if d.vr then
			sh=s.height
			y1 = y1 % sh + y - y % sh - sh
			y2=y + h
		end

		for X=x1,x2,sw do for Y=y1,y2,sh do s:draw(X,Y)end end
	end)
	return ts,bg
end
local ts,bg=Object.find("PELDR_TS"),Object.find("PELDR_BG")
if ts == nil then ts,bg=mkObjs()end

local function spawnBG(sprite, depth, x, y, hrepeat, vrepeat, xparallax, yparallax, xpercentoffs, ypercentoffs)
	local i=bg:create(0,0)
	d=i:getModData("PELDR")
	i.depth = depth
	d.s = sprite
	d.x = x
	d.y = y
	d.hr = hrepeat
	d.vr = vrepeat
	d.px = xparallax
	d.py = yparallax
	d.xo = xpercentoffs
	d.yo = ypercentoffs
end

local function spawnTS(sprite, depth, tiles, grid)
	local i=ts:create(0,0)
	d=i:getModData("PELDR")
    i.depth = depth
    d.c = {}
    d.s = sprite
    d.g = grid
    d.t = tiles
end

local room = Room.new(STAGE_INFO.name)
room:resize(STAGE_INFO.width, STAGE_INFO.height)
for col, coordlist in pairs(STAGE_COLLISION) do
	local obj = Object.find(col, "Vanilla")
	for _, coords in ipairs(coordlist) do
        room:createInstance(obj, coords[1]*8, coords[2]*8)
    end
end
for _, objectlist in ipairs(STAGE_OBJECTS) do
	local obj = r("Object", objectlist[1], objectlist[2])
	for _, coords in ipairs(objectlist[3]) do
		room:createInstance(obj, coords[1]*8, coords[2]*8)
	end
end

local stage = Stage.new(STAGE_INFO.name)
stage.subname = STAGE_INFO.subname
stage.rooms:add(room)
stage.music = Sound.find(STAGE_INFO.music) or Sound.find("MusicStage1")

for _, i in ipairs(STAGE_INTERACTABLES) do
    stage.interactables:add(r("Interactable", i[1], i[2]))
end
for _, e in ipairs(STAGE_ENEMIES) do
    stage.enemies:add(r("MonsterCard", e[1], e[2]))
end

local bgs = {}
for k, v in pairs(STAGE_BACKGROUNDS) do
    table.insert(bgs, {r("Sprite", v[1], v[2]), k, v[7], v[8], v[3]==1, v[4]==1, v[5], v[6], v[9], v[10]})
end
local lrs = {}
for _, v in ipairs(STAGE_LAYERS) do
    table.insert(lrs, {r("Sprite", v.sprite, v.origin), v.depth, v.tiles, v.grid})
end
local function mrgcol(o)
    for _, v in ipairs(o:findAll()) do
        v.xscale = 1 / 16
    end
    local c
    repeat
        c = 0
        for _, v in ipairs(o:findAll()) do
            if v:isValid() and v.xscale < 1 then
                local s = o:findPoint(v:get("bbox_right") + 16, v.y)
                if s and s.xscale < 1 then
                    c = 1
                    v.xscale = v.xscale + s.xscale
                    s:destroy()
                end
            end
        end
    until c == 0
end
local bs = Object.find("bossSpawn","vanilla")
local bs2 = Object.find("bossSpawn2","vanilla")
callback("globalRoomStart", function(r)
    if r == room then
        for _, v in ipairs(bgs) do
            spawnBG(table.unpack(v))
        end
        for _, v in ipairs(lrs) do
            spawnTS(table.unpack(v))
        end
        mrgcol(bs)
        mrgcol(bs2)
    end
end)


return stage